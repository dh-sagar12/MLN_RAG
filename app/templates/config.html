{% extends "base.html" %}

{% block title %}Configuration - RAG Chatbot{% endblock %}

{% block content %}
<div class="max-w-7xl mx-auto">
    <div class="mb-6">
        <h1 class="text-3xl font-bold text-gray-900">Configuration</h1>
        <p class="mt-2 text-sm text-gray-600">Manage RAG parameters, retriever settings, and system prompts</p>
    </div>

    <!-- Category Tabs -->
    <div class="mb-6 border-b border-gray-200">
        <nav class="-mb-px flex space-x-8 font-bold" aria-label="Tabs">
            <button onclick="filterCategory('')" class="category-tab border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300 whitespace-nowrap py-4 px-1 border-b-2  text-sm active" data-category="">
                All Settings
            </button>
            <button onclick="filterCategory('rag')" class="category-tab border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300 whitespace-nowrap py-4 px-1 border-b-2  text-sm" data-category="rag">
                RAG Parameters
            </button>
            <button onclick="filterCategory('retriever')" class="category-tab border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300 whitespace-nowrap py-4 px-1 border-b-2  text-sm" data-category="retriever">
                Retriever Settings
            </button>
            <button onclick="filterCategory('hybrid')" class="category-tab border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300 whitespace-nowrap py-4 px-1 border-b-2  text-sm" data-category="hybrid">
                Hybrid Retriever
            </button>
            <button onclick="filterCategory('prompt')" class="category-tab border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300 whitespace-nowrap py-4 px-1 border-b-2  text-sm" data-category="prompt">
                Prompts
            </button>
            <button onclick="filterCategory('ingestion')" class="category-tab border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300 whitespace-nowrap py-4 px-1 border-b-2  text-sm" data-category="ingestion">
                Ingestion
            </button>
        </nav>
    </div>

    <!-- Success/Error Messages -->
    <div id="message-container" class="mb-4"></div>

    <!-- Configuration Sections -->
    <div id="config-sections" class="space-y-6">
        {% for category, configs in configs.items() %}
        <div class="config-section bg-white rounded-lg shadow-sm border border-gray-200 p-6" data-category="{{ category }}">
            <div class="mb-4">
                <h2 class="text-xl font-semibold text-gray-900 capitalize">{{ category }} Settings</h2>
                <p class="text-sm text-gray-500 mt-1">
                    {% if category == 'rag' %}
                        Configure RAG query parameters that affect retrieval and response generation
                    {% elif category == 'retriever' %}
                        Configure vector and BM25 retriever parameters
                    {% elif category == 'hybrid' %}
                        Configure hybrid retriever fusion and combination settings
                    {% elif category == 'prompt' %}
                        Customize system prompts for different channels and query enhancement
                    {% elif category == 'ingestion' %}
                        Configure document chunking parameters and node parser selection
                    {% else %}
                        General configuration settings
                    {% endif %}
                </p>
            </div>

            <div class="space-y-6">
                {% for config in configs %}
                <div class="config-item border-b border-gray-100 pb-6 last:border-b-0 last:pb-0">
                    <div class="flex items-start justify-between">
                        <div class="flex-1">
                            <div class="flex items-center space-x-2 mb-2">
                                <label class="text-sm font-medium text-gray-900">{{ config.key.split('.')[-1]|replace('_', ' ')|title }}</label>
                                <button onclick="resetConfig('{{ config.key }}')" class="text-xs text-blue-600 hover:text-blue-800" title="Reset to default">
                                    Reset
                                </button>
                            </div>
                            
                            {% if config.description %}
                            <p class="text-xs text-gray-500 mb-3">{{ config.description }}</p>
                            {% endif %}

                            <div class="mt-3">
                                {% if config.type == 'bool' %}
                                    <label class="relative inline-flex items-center cursor-pointer">
                                        <input type="checkbox" 
                                               id="config-{{ config.key }}" 
                                               class="sr-only peer"
                                               {% if config.value %}checked{% endif %}
                                               onchange="updateConfig('{{ config.key }}', this.checked)">
                                        <div class="w-11 h-6 bg-gray-200 peer-focus:outline-none peer-focus:ring-4 peer-focus:ring-blue-300 rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-blue-600"></div>
                                        <span class="ml-3 text-sm text-gray-700">
                                            {% if config.value %}Enabled{% else %}Disabled{% endif %}
                                        </span>
                                    </label>
                                {% elif config.type == 'string' and 'prompt' in config.key %}
                                    <textarea id="config-{{ config.key }}" 
                                              class="w-full px-3 py-5 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 text-sm font-mono"
                                              rows="20"
                                              onblur="updateConfig('{{ config.key }}', this.value)">{{ config.value|safe }}</textarea>
                                {% elif config.type == 'string' and 'mode' in config.key %}
                                    <select id="config-{{ config.key }}" 
                                            class="w-full max-w-xs px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 text-sm"
                                            onchange="updateConfig('{{ config.key }}', this.value)">
                                        {% if config.key == 'hybrid.mode' %}
                                            <option value="reciprocal_rerank" {% if config.value == 'reciprocal_rerank' %}selected{% endif %}>Reciprocal Rank Fusion</option>
                                            <option value="relative_score" {% if config.value == 'relative_score' %}selected{% endif %}>Relative Score</option>
                                            <option value="dist_based_score" {% if config.value == 'dist_based_score' %}selected{% endif %}>Distance-Based Score</option>
                                            <option value="simple" {% if config.value == 'simple' %}selected{% endif %}>Simple</option>
                                        {% elif config.key == 'rag.response_mode' %}
                                            <option value="compact" {% if config.value == 'compact' %}selected{% endif %}>Compact</option>
                                            <option value="refine" {% if config.value == 'refine' %}selected{% endif %}>Refine</option>
                                            <option value="tree_summarize" {% if config.value == 'tree_summarize' %}selected{% endif %}>Tree Summarize</option>
                                            <option value="simple_summarize" {% if config.value == 'simple_summarize' %}selected{% endif %}>Simple Summarize</option>
                                            <option value="accumulate" {% if config.value == 'accumulate' %}selected{% endif %}>Accumulate</option>
                                            <option value="compact_accumulate" {% if config.value == 'compact_accumulate' %}selected{% endif %}>Compact Accumulate</option>
                                            <option value="generation" {% if config.value == 'generation' %}selected{% endif %}>Generation</option>
                                            <option value="no_text" {% if config.value == 'no_text' %}selected{% endif %}>No Text</option>
                                            <option value="context_only" {% if config.value == 'context_only' %}selected{% endif %}>Context Only</option>
                                        {% elif config.key == 'ingestion.markdown_parser' %}
                                            <option value="markdown" {% if config.value == 'markdown' %}selected{% endif %}>Markdown Node Parser (preserves structure)</option>
                                            <option value="sentence" {% if config.value == 'sentence' %}selected{% endif %}>Sentence Splitter (simple text splitting)</option>
                                        {% endif %}
                                    </select>
                                {% else %}
                                    <input type="{% if config.type == 'int' %}number{% elif config.type == 'float' %}number{% else %}text{% endif %}" 
                                           id="config-{{ config.key }}" 
                                           class="w-full max-w-xs px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 text-sm"
                                           {% if config.type == 'int' %}step="1"{% elif config.type == 'float' %}step="0.01"{% endif %}
                                           value="{{ config.value }}"
                                           onblur="updateConfig('{{ config.key }}', this.value)">
                                {% endif %}
                            </div>
                        </div>
                    </div>
                </div>
                {% endfor %}
            </div>
        </div>
        {% endfor %}
    </div>

    <!-- Empty State -->
    <div id="empty-state" class="hidden text-center py-12">
        <p class="text-gray-500">No configurations found for the selected category.</p>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    let allConfigs = {};
    {% for category, configs in configs.items() %}
    allConfigs['{{ category }}'] = {{ configs|tojson }};
    {% endfor %}

    function filterCategory(category) {
        // Update active tab
        document.querySelectorAll('.category-tab').forEach(tab => {
            tab.classList.remove('active', 'border-blue-500', 'text-blue-600');
            tab.classList.add('border-transparent', 'text-gray-500');
        });
        const activeTab = document.querySelector(`[data-category="${category}"]`);
        if (activeTab) {
            activeTab.classList.add('active', 'border-blue-500', 'text-blue-600');
            activeTab.classList.remove('border-transparent', 'text-gray-500');
        }

        // Filter sections
        const sections = document.querySelectorAll('.config-section');
        let visibleCount = 0;
        sections.forEach(section => {
            const sectionCategory = section.getAttribute('data-category');
            if (category === '' || sectionCategory === category) {
                section.classList.remove('hidden');
                visibleCount++;
            } else {
                section.classList.add('hidden');
            }
        });

        // Show/hide empty state
        const emptyState = document.getElementById('empty-state');
        if (visibleCount === 0) {
            emptyState.classList.remove('hidden');
        } else {
            emptyState.classList.add('hidden');
        }
    }

    function showMessage(message, type = 'success') {
        const container = document.getElementById('message-container');
        const bgColor = type === 'success' ? 'bg-green-50 border-green-200 text-green-800' : 'bg-red-50 border-red-200 text-red-800';
        container.innerHTML = `
            <div class="${bgColor} border rounded-md p-4 flex items-center justify-between">
                <span>${message}</span>
                <button onclick="this.parentElement.remove()" class="ml-4 text-gray-400 hover:text-gray-600">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                    </svg>
                </button>
            </div>
        `;
        setTimeout(() => container.innerHTML = '', 5000);
    }

    async function updateConfig(key, value) {
        try {
            // Convert value based on type
            let typedValue = value;
            // Find config from all categories
            let config = null;
            for (const category in allConfigs) {
                config = allConfigs[category].find(c => c.key === key);
                if (config) break;
            }
            if (config) {
                if (config.type === 'int') {
                    typedValue = parseInt(value);
                } else if (config.type === 'float') {
                    typedValue = parseFloat(value);
                } else if (config.type === 'bool') {
                    typedValue = Boolean(value);
                }
            }

            const response = await fetch(`/api/config`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({ key, value: typedValue }),
            });

            if (response.ok) {
                const data = await response.json();
                showMessage(`Configuration "${key.split('.').pop()}" updated successfully`, 'success');
                
                // Update local state
                const category = key.split('.')[0];
                if (allConfigs[category]) {
                    const idx = allConfigs[category].findIndex(c => c.key === key);
                    if (idx !== -1) {
                        allConfigs[category][idx].value = data.value;
                    }
                }
            } else {
                const error = await response.json();
                showMessage(`Error: ${error.error || 'Failed to update configuration'}`, 'error');
            }
        } catch (error) {
            showMessage(`Error: ${error.message}`, 'error');
        }
    }

    async function resetConfig(key) {
        if (!confirm(`Reset "${key.split('.').pop()}" to default value?`)) {
            return;
        }

        try {
            const response = await fetch(`/api/config/${encodeURIComponent(key)}/reset`, {
                method: 'POST',
            });

            if (response.ok) {
                const data = await response.json();
                showMessage(`Configuration "${key.split('.').pop()}" reset to default`, 'success');
                
                // Update UI
                const input = document.getElementById(`config-${key}`);
                if (input) {
                    if (input.type === 'checkbox') {
                        input.checked = data.value;
                        input.nextElementSibling.textContent = data.value ? 'Enabled' : 'Disabled';
                    } else {
                        input.value = data.value;
                    }
                }

                // Update local state
                const category = key.split('.')[0];
                if (allConfigs[category]) {
                    const idx = allConfigs[category].findIndex(c => c.key === key);
                    if (idx !== -1) {
                        allConfigs[category][idx].value = data.value;
                    }
                }
            } else {
                const error = await response.json();
                showMessage(`Error: ${error.error || 'Failed to reset configuration'}`, 'error');
            }
        } catch (error) {
            showMessage(`Error: ${error.message}`, 'error');
        }
    }

    // Initialize category filter if provided
    {% if current_category %}
    filterCategory('{{ current_category }}');
    {% endif %}
</script>
{% endblock %}

