{% extends "base.html" %}

{% block title %}Chat - RAG Chatbot{% endblock %}

{% block content %}
<div class="flex h-[calc(100vh-8rem)] gap-4">
    <!-- Chat Sessions Sidebar -->
    <div class="w-64 bg-white rounded-lg shadow p-4 flex flex-col">
        <div class="flex justify-between items-center mb-4">
            <h2 class="text-lg font-semibold">Chat Sessions</h2>
            <button id="new-chat-btn" class="text-blue-600 hover:text-blue-800 text-sm font-medium">
                + New
            </button>
        </div>
        <div id="chat-sessions" class="flex-1 overflow-y-auto space-y-2">
            <!-- Sessions will be loaded here -->
        </div>
    </div>
    
    <!-- Main Chat Area -->
    <div class="flex-1 flex flex-col bg-white rounded-lg shadow">
        <div class="p-4 border-b flex justify-between items-center">
            <h1 class="text-2xl font-bold text-gray-900" id="chat-title">New Chat</h1>
            <!-- Co-pilot Mode Toggle -->
            <div class="flex items-center gap-3">
                <span class="text-sm text-gray-600">Co-pilot Mode</span>
                <label class="relative inline-flex items-center cursor-pointer">
                    <input type="checkbox" id="copilot-toggle" class="sr-only peer" checked>
                    <div class="w-11 h-6 bg-gray-200 peer-focus:outline-none peer-focus:ring-4 peer-focus:ring-amber-300 rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-amber-500"></div>
                </label>
                <span id="copilot-status" class="text-xs px-2 py-1 rounded-full bg-amber-100 text-amber-700">
                    Draft Mode Active
                </span>
            </div>
        </div>
        
        <!-- Chat Messages -->
        <div id="chat-messages" class="flex-1 overflow-y-auto p-4 space-y-4 bg-gray-50">
            <div class="text-center text-gray-500 py-8">
                Start a conversation by asking a question below.
            </div>
        </div>
        
        <!-- Draft Panel (Hidden by default) -->
        <div id="draft-panel" class="hidden border-t-2 border-amber-400 bg-amber-50">
            <div class="p-4">
                <div class="flex justify-between items-start mb-3">
                    <div class="flex items-center gap-2">
                        <span class="text-amber-600 text-lg">üìù</span>
                        <h3 class="font-semibold text-amber-800">Draft Response</h3>
                        <span class="text-xs bg-amber-200 text-amber-800 px-2 py-1 rounded-full">Manager Review</span>
                    </div>
                    <div class="flex gap-2">
                        <button id="approve-draft-btn" class="px-3 py-1.5 bg-emerald-600 text-white rounded-md hover:bg-emerald-700 text-sm font-medium transition-colors flex items-center gap-1">
                            <span>‚úì</span> Approve
                        </button>
                        <button id="discard-draft-btn" class="px-3 py-1.5 bg-red-500 text-white rounded-md hover:bg-red-600 text-sm font-medium transition-colors flex items-center gap-1">
                            <span>‚úï</span> Discard
                        </button>
                    </div>
                </div>
                
                <!-- Original Customer Query Display -->
                <div class="mb-3 p-2 bg-white rounded border border-amber-200">
                    <span class="text-xs text-gray-500 font-medium">üë§ Customer's Question:</span>
                    <p id="draft-original-query" class="text-sm text-gray-800 mt-1"></p>
                </div>
                
                <!-- AI Draft Response to Customer (Scrollable Area) -->
                <div class="mb-3 max-h-48 overflow-y-auto">
                    <p class="text-xs text-gray-500 font-medium mb-1">ü§ñ AI's Draft Response (will be sent to customer):</p>
                    <div id="draft-content" class="p-3 bg-white rounded border border-amber-200 markdown-content text-gray-800"></div>
                </div>
                
                <!-- Refinement History (Manager Instructions & AI Updates) -->
                <div id="refinement-history" class="mb-3 space-y-2 max-h-32 overflow-y-auto hidden">
                    <p class="text-xs text-amber-600 font-medium mb-1">üìù Refinement History:</p>
                    <!-- Refinement messages will appear here -->
                </div>
                
                <!-- Refinement Input (Manager Instructions) -->
                <div class="flex gap-2">
                    <input type="text" id="refinement-input" 
                           placeholder="Manager instruction... (e.g., 'Add pricing details' or 'Include permit info')"
                           class="flex-1 rounded-md border-amber-300 shadow-sm focus:border-amber-500 focus:ring-amber-500 sm:text-sm px-3 py-2 border">
                    <button id="refine-btn" class="px-4 py-2 bg-amber-600 text-white rounded-md hover:bg-amber-700 focus:outline-none focus:ring-2 focus:ring-amber-500 disabled:opacity-50 disabled:cursor-not-allowed text-sm font-medium transition-colors">
                        Refine
                    </button>
                </div>
                <p class="text-xs text-amber-700 mt-2">üìã <strong>Manager Mode:</strong> Your instructions will improve the AI's response before it's sent to the customer</p>
            </div>
        </div>
        
        <!-- Query Form -->
        <div class="p-4 border-t bg-white">
            <form id="query-form" class="space-y-3">
                <div class="flex items-end space-x-2 flex-wrap">
                    <div class="flex-1">
                        <textarea id="query" name="query" rows="2" required
                                  class="block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 sm:text-sm px-3 py-2 border resize-none"
                                  placeholder="Ask a question about your knowledge bases..."></textarea>
                    </div>
                    <div class="flex items-center space-x-2">
                        <div>
                            <label for="top_k" class="block text-xs text-gray-600 mb-1">Top K</label>
                            <input type="number" id="top_k" name="top_k" value="20" min="1" max="100"
                                   class="block w-16 rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 sm:text-sm px-2 py-1 border">
                        </div>
                        <div>
                            <label for="history_k" class="block text-xs text-gray-600 mb-1">History</label>
                            <input type="number" id="history_k" name="history_k" value="20" min="0" max="100"
                                   class="block w-16 rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 sm:text-sm px-2 py-1 border">
                        </div>
                        <div>
                            <label for="channel" class="block text-xs text-gray-600 mb-1">Channel</label>
                            <select id="channel" name="channel"
                                    class="block w-28 rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 sm:text-sm px-2 py-1 border">
                                <option value="email" selected>Email</option>
                                <option value="whatsapp">WhatsApp</option>
                            </select>
                        </div>
                        <button type="submit" id="submit-btn"
                                class="px-4 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500 disabled:opacity-50 disabled:cursor-not-allowed">
                            Send
                        </button>
                    </div>
                </div>
            </form>
        </div>
    </div>
    
    <!-- Results Section (Collapsible) -->
    <div id="results-section" class="w-64 bg-white rounded-lg shadow p-4 hidden">
        <div class="flex justify-between items-center mb-4">
            <h2 class="text-lg font-semibold">Sources</h2>
            <button id="close-sources" class="text-gray-500 hover:text-gray-700">√ó</button>
        </div>
        <div id="sources" class="overflow-y-auto space-y-2 text-sm"></div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/dompurify/3.0.6/purify.min.js"></script>

<style>
    /* Markdown Styles within Chat Bubbles */
    .markdown-content p {
        margin-bottom: 0.5em;
    }
    .markdown-content p:last-child {
        margin-bottom: 0;
    }
    .markdown-content ul {
        list-style-type: disc;
        padding-left: 1.5em;
        margin-bottom: 0.5em;
    }
    .markdown-content ol {
        list-style-type: decimal;
        padding-left: 1.5em;
        margin-bottom: 0.5em;
    }
    .markdown-content li {
        margin-bottom: 0.25em;
    }
    .markdown-content strong {
        font-weight: 600;
    }
    .markdown-content em {
        font-style: italic;
    }
    .markdown-content code {
        background-color: rgba(0, 0, 0, 0.1);
        padding: 0.2em 0.4em;
        border-radius: 3px;
        font-family: monospace;
        font-size: 0.9em;
    }
    .markdown-content pre {
        background-color: #f3f4f6;
        padding: 0.8em;
        border-radius: 4px;
        overflow-x: auto;
        margin-bottom: 0.5em;
    }
    .markdown-content pre code {
        background-color: transparent;
        padding: 0;
    }
    .markdown-content h1, .markdown-content h2, .markdown-content h3, .markdown-content h4 {
        font-weight: bold;
        margin-top: 0.5em;
        margin-bottom: 0.3em;
    }
    .markdown-content h1 { font-size: 1.5em; }
    .markdown-content h2 { font-size: 1.3em; }
    .markdown-content h3 { font-size: 1.1em; }
    .markdown-content blockquote {
        border-left: 3px solid #d1d5db;
        padding-left: 1em;
        color: #4b5563;
        font-style: italic;
    }
    .markdown-content a {
        color: #2563eb;
        text-decoration: underline;
    }
    /* Adjust link color for user messages (white text) */
    .bg-blue-600 .markdown-content a {
        color: #bfdbfe;
    }
    .bg-blue-600 .markdown-content code {
        background-color: rgba(255, 255, 255, 0.2);
    }
    
    /* Draft Panel Animations */
    #draft-panel {
        transition: all 0.3s ease-in-out;
    }
    
    #draft-panel.showing {
        animation: slideUp 0.3s ease-out;
    }
    
    @keyframes slideUp {
        from {
            opacity: 0;
            transform: translateY(20px);
        }
        to {
            opacity: 1;
            transform: translateY(0);
        }
    }
    
    /* Refinement history styling */
    .refinement-message {
        padding: 0.5rem 0.75rem;
        border-radius: 0.5rem;
        font-size: 0.875rem;
    }
    
    .refinement-manager {
        background-color: #fef3c7;
        border: 1px solid #fcd34d;
        margin-left: 1rem;
    }
    
    /* Legacy support for existing data */
    .refinement-user {
        background-color: #fef3c7;
        border: 1px solid #fcd34d;
        margin-left: 1rem;
    }
    
    .refinement-assistant {
        background-color: white;
        border: 1px solid #e5e7eb;
        margin-right: 1rem;
    }
    
    /* Co-pilot toggle animation */
    #copilot-toggle:checked + div {
        background-color: #f59e0b;
    }
</style>

<script>
let currentSessionId = null;
let chatHistory = [];
let copilotMode = true;  // Co-pilot mode enabled by default
let currentDraftId = null;

// DOM elements
const chatMessages = document.getElementById('chat-messages');
const queryForm = document.getElementById('query-form');
const submitBtn = document.getElementById('submit-btn');
const queryTextarea = document.getElementById('query');
const channelSelect = document.getElementById('channel');
const chatSessionsDiv = document.getElementById('chat-sessions');
const newChatBtn = document.getElementById('new-chat-btn');
const chatTitle = document.getElementById('chat-title');
const resultsSection = document.getElementById('results-section');
const sourcesDiv = document.getElementById('sources');
const closeSourcesBtn = document.getElementById('close-sources');

// Co-pilot elements
const copilotToggle = document.getElementById('copilot-toggle');
const copilotStatus = document.getElementById('copilot-status');
const draftPanel = document.getElementById('draft-panel');
const draftContent = document.getElementById('draft-content');
const draftOriginalQuery = document.getElementById('draft-original-query');
const refinementHistory = document.getElementById('refinement-history');
const refinementInput = document.getElementById('refinement-input');
const refineBtn = document.getElementById('refine-btn');
const approveDraftBtn = document.getElementById('approve-draft-btn');
const discardDraftBtn = document.getElementById('discard-draft-btn');

// Load chat sessions on page load
loadChatSessions();

// Check if we have a session_id in URL
const urlParams = new URLSearchParams(window.location.search);
const sessionIdFromUrl = urlParams.get('session_id');
if (sessionIdFromUrl) {
    loadChatSession(sessionIdFromUrl);
}

// Event listeners
newChatBtn.addEventListener('click', createNewChat);
queryForm.addEventListener('submit', handleQuery);
closeSourcesBtn.addEventListener('click', () => {
    resultsSection.classList.add('hidden');
});

// Co-pilot event listeners
copilotToggle.addEventListener('change', handleCopilotToggle);
refineBtn.addEventListener('click', handleRefineDraft);
approveDraftBtn.addEventListener('click', handleApproveDraft);
discardDraftBtn.addEventListener('click', handleDiscardDraft);

refinementInput.addEventListener('keydown', (e) => {
    if (e.key === 'Enter' && !e.shiftKey) {
        e.preventDefault();
        handleRefineDraft();
    }
});

// Add Ctrl+Enter support for submitting query
queryTextarea.addEventListener('keydown', (e) => {
    if (e.ctrlKey && e.key === 'Enter') {
        e.preventDefault();
        queryForm.dispatchEvent(new Event('submit'));
    }
});

async function handleCopilotToggle() {
    copilotMode = copilotToggle.checked;
    
    if (copilotMode) {
        copilotStatus.classList.remove('hidden');
        copilotStatus.textContent = 'Draft Mode Active';
        copilotStatus.classList.remove('bg-gray-100', 'text-gray-600');
        copilotStatus.classList.add('bg-amber-100', 'text-amber-700');
    } else {
        copilotStatus.classList.add('hidden');
        // Hide draft panel if switching off copilot mode
        hideDraftPanel();
    }
    
    // Save preference to session if exists
    if (currentSessionId) {
        try {
            await fetch(`/api/chat/sessions/${currentSessionId}/copilot`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ enabled: copilotMode })
            });
        } catch (error) {
            console.error('Error saving copilot preference:', error);
        }
    }
}

function showDraftPanel(originalQuery, draftText, sources = null) {
    draftOriginalQuery.textContent = originalQuery;
    const parsedContent = DOMPurify.sanitize(marked.parse(draftText));
    draftContent.innerHTML = parsedContent;
    
    draftPanel.classList.remove('hidden');
    draftPanel.classList.add('showing');
    
    // Clear refinement history display
    refinementHistory.innerHTML = '';
    refinementHistory.classList.add('hidden');
    
    // Show sources if available
    if (sources && (sources.kbs_used?.length > 0 || sources.chunks?.length > 0)) {
        showSources(sources);
    }
}

function hideDraftPanel() {
    draftPanel.classList.add('hidden');
    draftPanel.classList.remove('showing');
    currentDraftId = null;
    refinementInput.value = '';
    refinementHistory.innerHTML = '';
    refinementHistory.classList.add('hidden');
}

function updateDraftContent(newContent) {
    const parsedContent = DOMPurify.sanitize(marked.parse(newContent));
    draftContent.innerHTML = parsedContent;
}

function addRefinementMessage(role, content) {
    refinementHistory.classList.remove('hidden');
    
    const msgDiv = document.createElement('div');
    // Support both 'user' (legacy) and 'manager' roles for refinement requests
    const isManagerMessage = role === 'user' || role === 'manager';
    msgDiv.className = `refinement-message ${isManagerMessage ? 'refinement-manager' : 'refinement-assistant'}`;
    
    if (isManagerMessage) {
        msgDiv.innerHTML = `<span class="text-amber-800 font-medium">üìã Manager:</span> ${content}`;
    } else {
        msgDiv.innerHTML = `<span class="text-gray-600 font-medium">‚úÖ Draft Updated</span>`;
    }
    
    refinementHistory.appendChild(msgDiv);
    refinementHistory.scrollTop = refinementHistory.scrollHeight;
}

async function handleRefineDraft() {
    const refinementRequest = refinementInput.value.trim();
    if (!refinementRequest || !currentDraftId) return;
    
    refineBtn.disabled = true;
    refineBtn.textContent = 'Refining...';
    refinementInput.disabled = true;
    
    // Add manager's refinement instruction to history
    addRefinementMessage('manager', refinementRequest);
    refinementInput.value = '';
    
    try {
        const response = await fetch(`/api/draft/${currentDraftId}/refine`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                refinement: refinementRequest,
                session_id: currentSessionId,
                top_k: parseInt(document.getElementById('top_k').value) || 7,
                history_k: parseInt(document.getElementById('history_k').value) || 20,
                channel: (channelSelect?.value || 'email').toLowerCase()
            })
        });
        
        const data = await response.json();
        
        if (data.success) {
            updateDraftContent(data.current_draft);
            addRefinementMessage('assistant', 'Draft updated');
            
            // Update sources if available
            if (data.kbs_used?.length > 0 || data.chunks?.length > 0) {
                showSources(data);
            }
        } else {
            alert('Failed to refine draft: ' + (data.error || 'Unknown error'));
        }
    } catch (error) {
        console.error('Error refining draft:', error);
        alert('Error refining draft');
    } finally {
        refineBtn.disabled = false;
        refineBtn.textContent = 'Refine';
        refinementInput.disabled = false;
        refinementInput.focus();
    }
}

async function handleApproveDraft() {
    if (!currentDraftId) return;
    
    approveDraftBtn.disabled = true;
    approveDraftBtn.textContent = 'Approving...';
    
    try {
        const response = await fetch(`/api/draft/${currentDraftId}/approve`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' }
        });
        
        const data = await response.json();
        
        if (data.success) {
            // Add messages to chat display
            const originalQuery = draftOriginalQuery.textContent;
            const approvedContent = draftContent.textContent;
            
            addMessage('user', originalQuery);
            chatHistory.push({ role: 'user', content: originalQuery });
            
            // Get the actual draft content (from the innerHTML, parsed)
            const draftTextContent = draftContent.querySelector('.markdown-content')?.innerHTML || draftContent.innerHTML;
            addMessageWithHTML('assistant', draftTextContent);
            chatHistory.push({ role: 'assistant', content: approvedContent });
            
            hideDraftPanel();
            
            // Reload sessions to update title
            await loadChatSessions();
        } else {
            alert('Failed to approve draft: ' + (data.error || 'Unknown error'));
        }
    } catch (error) {
        console.error('Error approving draft:', error);
        alert('Error approving draft');
    } finally {
        approveDraftBtn.disabled = false;
        approveDraftBtn.innerHTML = '<span>‚úì</span> Approve';
    }
}

async function handleDiscardDraft() {
    if (!currentDraftId) return;
    
    if (!confirm('Are you sure you want to discard this draft?')) return;
    
    discardDraftBtn.disabled = true;
    discardDraftBtn.textContent = 'Discarding...';
    
    try {
        const response = await fetch(`/api/draft/${currentDraftId}/discard`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' }
        });
        
        const data = await response.json();
        
        if (data.success) {
            hideDraftPanel();
        } else {
            alert('Failed to discard draft: ' + (data.error || 'Unknown error'));
        }
    } catch (error) {
        console.error('Error discarding draft:', error);
        alert('Error discarding draft');
    } finally {
        discardDraftBtn.disabled = false;
        discardDraftBtn.innerHTML = '<span>‚úï</span> Discard';
    }
}

async function loadChatSessions() {
    try {
        const response = await fetch('/api/chat/sessions');
        const data = await response.json();
        
        chatSessionsDiv.innerHTML = '';
        
        if (data.sessions && data.sessions.length > 0) {
            data.sessions.forEach(session => {
                const sessionDiv = createSessionElement(session);
                chatSessionsDiv.appendChild(sessionDiv);
            });
        } else {
            chatSessionsDiv.innerHTML = '<p class="text-sm text-gray-500 text-center py-4">No chat sessions yet</p>';
        }
    } catch (error) {
        console.error('Error loading chat sessions:', error);
    }
}

function createSessionElement(session) {
    const div = document.createElement('div');
    div.className = `p-2 rounded cursor-pointer hover:bg-gray-100 ${currentSessionId === session.id ? 'bg-blue-50 border border-blue-200' : ''}`;
    div.dataset.sessionId = session.id;
    
    div.innerHTML = `
        <div class="flex justify-between items-start">
            <div class="flex-1 min-w-0">
                <p class="text-sm font-medium text-gray-900 truncate">${session.title || 'New Chat'}</p>
                <p class="text-xs text-gray-500">${new Date(session.updated_at).toLocaleDateString()}</p>
            </div>
            <button class="delete-session ml-2 text-red-500 hover:text-red-700 text-xs" data-session-id="${session.id}">√ó</button>
        </div>
    `;
    
    div.addEventListener('click', (e) => {
        if (!e.target.classList.contains('delete-session')) {
            loadChatSession(session.id);
        }
    });
    
    div.querySelector('.delete-session').addEventListener('click', async (e) => {
        e.stopPropagation();
        if (confirm('Delete this chat session?')) {
            await deleteChatSession(session.id);
        }
    });
    
    return div;
}

async function createNewChat() {
    try {
        const response = await fetch('/api/chat/sessions', {
            method: 'POST'
        });
        const data = await response.json();
        
        currentSessionId = data.session_id;
        chatHistory = [];
        chatTitle.textContent = 'New Chat';
        chatMessages.innerHTML = '<div class="text-center text-gray-500 py-8">Start a conversation by asking a question below.</div>';
        resultsSection.classList.add('hidden');
        hideDraftPanel();
        
        // Keep copilot mode enabled by default for new session
        copilotToggle.checked = true;
        copilotMode = true;
        copilotStatus.classList.remove('hidden');
        copilotStatus.classList.remove('bg-gray-100', 'text-gray-600');
        copilotStatus.classList.add('bg-amber-100', 'text-amber-700');
        
        // Update URL
        window.history.pushState({}, '', `/chat?session_id=${currentSessionId}`);
        
        // Reload sessions
        await loadChatSessions();
    } catch (error) {
        console.error('Error creating new chat:', error);
        alert('Failed to create new chat');
    }
}

async function loadChatSession(sessionId) {
    try {
        const response = await fetch(`/api/chat/sessions/${sessionId}`);
        const data = await response.json();
        
        if (data.error) {
            alert(data.error);
            return;
        }
        
        currentSessionId = sessionId;
        chatTitle.textContent = data.title || 'New Chat';
        
        // Load messages
        chatMessages.innerHTML = '';
        chatHistory = [];
        hideDraftPanel();
        
        if (data.messages && data.messages.length > 0) {
            data.messages.forEach(msg => {
                addMessage(msg.role, msg.content, false);
                chatHistory.push({ role: msg.role, content: msg.content });
            });
        } else {
            chatMessages.innerHTML = '<div class="text-center text-gray-500 py-8">Start a conversation by asking a question below.</div>';
        }
        
        // Check for active draft
        await checkActiveDraft(sessionId);
        
        // Update URL
        window.history.pushState({}, '', `/chat?session_id=${sessionId}`);
        
        // Reload sessions to update active state
        await loadChatSessions();
    } catch (error) {
        console.error('Error loading chat session:', error);
        alert('Failed to load chat session');
    }
}

async function checkActiveDraft(sessionId) {
    try {
        const response = await fetch(`/api/chat/sessions/${sessionId}/draft`);
        const data = await response.json();
        
        if (data.draft_id) {
            currentDraftId = data.draft_id;
            copilotMode = true;
            copilotToggle.checked = true;
            copilotStatus.classList.remove('hidden');
            copilotStatus.classList.remove('bg-gray-100', 'text-gray-600');
            copilotStatus.classList.add('bg-amber-100', 'text-amber-700');
            
            showDraftPanel(data.original_query, data.current_draft, data.sources_data);
            
            // Load refinement history
            if (data.refinement_history && data.refinement_history.length > 0) {
                data.refinement_history.forEach(msg => {
                    addRefinementMessage(msg.role, msg.content);
                });
            }
        }
    } catch (error) {
        console.error('Error checking active draft:', error);
    }
}

async function deleteChatSession(sessionId) {
    try {
        const response = await fetch(`/api/chat/sessions/${sessionId}`, {
            method: 'DELETE'
        });
        
        if (response.ok) {
            if (currentSessionId === sessionId) {
                currentSessionId = null;
                chatHistory = [];
                chatTitle.textContent = 'New Chat';
                chatMessages.innerHTML = '<div class="text-center text-gray-500 py-8">Start a conversation by asking a question below.</div>';
                window.history.pushState({}, '', '/chat');
                hideDraftPanel();
            }
            await loadChatSessions();
        }
    } catch (error) {
        console.error('Error deleting chat session:', error);
        alert('Failed to delete chat session');
    }
}

async function handleQuery(e) {
    e.preventDefault();
    
    const queryInput = document.getElementById('query');
    const query = queryInput.value.trim();
    const topK = parseInt(document.getElementById('top_k').value) || 20;
    const historyK = parseInt(document.getElementById('history_k').value) || 20;
    const channel = (channelSelect?.value || 'email').toLowerCase();
    
    if (!query) return;
    
    // Create session if doesn't exist
    if (!currentSessionId) {
        await createNewChat();
    }
    
    // Clear input field immediately
    queryInput.value = '';
    
    // Disable form
    submitBtn.disabled = true;
    submitBtn.textContent = 'Sending...';
    queryInput.disabled = true;
    
    // In copilot mode, don't add user message to chat yet
    if (!copilotMode) {
        // Add user message
        addMessage('user', query);
        chatHistory.push({ role: 'user', content: query });
    }
    
    // Show "AI is thinking" indicator (always show, regardless of mode)
    const thinkingMessageId = addThinkingMessage();
    
    // Clear previous results
    sourcesDiv.innerHTML = '';
    resultsSection.classList.add('hidden');
    
    try {
        const response = await fetch('/api/query', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                query,
                top_k: topK,
                session_id: currentSessionId,
                history_k: historyK,
                channel,
                copilot_mode: copilotMode
            })
        });
        
        const data = await response.json();
        
        // Remove thinking indicator
        removeThinkingMessage(thinkingMessageId);
        
        if (data.error) {
            if (!copilotMode) {
                addMessage('assistant', `Error: ${data.error}`, 'text-red-600');
            } else {
                alert('Error: ' + data.error);
            }
        } else {
            if (copilotMode && data.is_draft) {
                // Show draft panel
                currentDraftId = data.draft_id;
                showDraftPanel(query, data.answer, {
                    sources: data.sources,
                    kbs_used: data.kbs_used,
                    chunks: data.chunks
                });
            } else {
                // Normal mode - add assistant message
                addMessage('assistant', data.answer);
                chatHistory.push({ role: 'assistant', content: data.answer });
                
                // Show sources
                if (data.kbs_used && data.kbs_used.length > 0) {
                    showSources(data);
                }
                
                // Reload sessions to update title if needed
                await loadChatSessions();
            }
        }
    } catch (error) {
        // Remove thinking indicator
        removeThinkingMessage(thinkingMessageId);
        if (!copilotMode) {
            addMessage('assistant', `Error: ${error.message}`, 'text-red-600');
        } else {
            alert('Error: ' + error.message);
        }
    } finally {
        // Re-enable form
        submitBtn.disabled = false;
        submitBtn.textContent = 'Send';
        queryInput.disabled = false;
        queryInput.focus();
    }
}

function addMessage(role, content, scroll = true) {
    // Remove placeholder if exists
    const placeholder = chatMessages.querySelector('.text-center');
    if (placeholder) placeholder.remove();
    
    const messageDiv = document.createElement('div');
    messageDiv.className = `flex ${role === 'user' ? 'justify-end' : 'justify-start'}`;
    
    const bubble = document.createElement('div');
    bubble.className = `max-w-[80%] rounded-lg px-4 py-2 ${
        role === 'user' 
            ? 'bg-blue-600 text-white' 
            : 'bg-white border text-gray-800'
    }`;
    
    // Parse markdown and sanitize
    const parsedContent = DOMPurify.sanitize(marked.parse(content));
    bubble.innerHTML = `<div class="markdown-content">${parsedContent}</div>`;
    
    messageDiv.appendChild(bubble);
    chatMessages.appendChild(messageDiv);
    
    if (scroll) {
        chatMessages.scrollTop = chatMessages.scrollHeight;
    }
}

function addMessageWithHTML(role, htmlContent, scroll = true) {
    // Remove placeholder if exists
    const placeholder = chatMessages.querySelector('.text-center');
    if (placeholder) placeholder.remove();
    
    const messageDiv = document.createElement('div');
    messageDiv.className = `flex ${role === 'user' ? 'justify-end' : 'justify-start'}`;
    
    const bubble = document.createElement('div');
    bubble.className = `max-w-[80%] rounded-lg px-4 py-2 ${
        role === 'user' 
            ? 'bg-blue-600 text-white' 
            : 'bg-white border text-gray-800'
    }`;
    
    bubble.innerHTML = `<div class="markdown-content">${htmlContent}</div>`;
    
    messageDiv.appendChild(bubble);
    chatMessages.appendChild(messageDiv);
    
    if (scroll) {
        chatMessages.scrollTop = chatMessages.scrollHeight;
    }
}

function addThinkingMessage() {
    // Remove placeholder if exists
    const placeholder = chatMessages.querySelector('.text-center');
    if (placeholder) placeholder.remove();
    
    const messageDiv = document.createElement('div');
    messageDiv.className = 'flex justify-start';
    messageDiv.id = 'thinking-message';
    
    const bubble = document.createElement('div');
    bubble.className = 'max-w-[80%] rounded-lg px-4 py-2 bg-white border text-gray-800';
    
    // Create thinking indicator with animated dots
    const thinkingText = document.createElement('span');
    thinkingText.textContent = copilotMode ? 'AI is preparing draft' : 'AI is thinking';
    thinkingText.className = 'inline-block';
    
    const dots = document.createElement('span');
    dots.id = 'thinking-dots';
    dots.textContent = '...';
    dots.className = 'inline-block animate-pulse';
    
    bubble.appendChild(thinkingText);
    bubble.appendChild(dots);
    messageDiv.appendChild(bubble);
    chatMessages.appendChild(messageDiv);
    
    chatMessages.scrollTop = chatMessages.scrollHeight;
    
    // Return the message div for later removal
    return messageDiv;
}

function removeThinkingMessage(thinkingMessageDiv) {
    if (thinkingMessageDiv && thinkingMessageDiv.parentNode) {
        thinkingMessageDiv.remove();
    }
}

function showSources(data) {
    let sourcesHTML = '<div class="space-y-3">';
    
    if (data.kbs_used && data.kbs_used.length > 0) {
        sourcesHTML += `<p class="font-medium text-gray-700 text-xs">Knowledge Bases:</p>`;
        sourcesHTML += `<ul class="list-disc list-inside space-y-1 text-xs text-gray-600">`;
        data.kbs_used.forEach(kb => {
            sourcesHTML += `<li>${kb}</li>`;
        });
        sourcesHTML += `</ul>`;
    }
    
    if (data.chunks && data.chunks.length > 0) {
        sourcesHTML += `<p class="font-medium text-gray-700 text-xs mt-3">Relevant Chunks:</p>`;
        data.chunks.forEach((chunk, idx) => {
            sourcesHTML += `<div class="border rounded p-2 bg-gray-50 mt-1">`;
            sourcesHTML += `<p class="text-xs text-gray-500 mb-1">${chunk.kb_name} (${(chunk.similarity * 100).toFixed(1)}%)</p>`;
            sourcesHTML += `<p class="text-xs text-gray-700">${chunk.text.substring(0, 150)}${chunk.text.length > 150 ? '...' : ''}</p>`;
            sourcesHTML += `</div>`;
        });
    }
    
    sourcesHTML += '</div>';
    sourcesDiv.innerHTML = sourcesHTML;
    resultsSection.classList.remove('hidden');
}
</script>
{% endblock %}
